name: ğŸš€ TimmyBot CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'build.gradle.kts'
      - 'Dockerfile'
      - '.github/workflows/**'

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: timmybot
  ECS_SERVICE: timmybot-dev-service
  ECS_CLUSTER: timmybot-dev-cluster
  CONTAINER_NAME: timmybot-dev-container

jobs:
  # ================================
  # STREAMLINED BUILD, TEST & DEPLOY
  # ================================
  build-test-deploy:
    name: ğŸš€ Build, Test & Deploy TimmyBot
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ğŸ”§ Make gradlew executable
      run: chmod +x gradlew
      
    - name: ğŸ§ª Run unit tests
      run: ./gradlew test
      
    - name: ğŸ“Š Upload test results (optional)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: build/test-results
      
    - name: ğŸ—ï¸ Build application
      run: ./gradlew build
      
    - name: ğŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸƒ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: ğŸ·ï¸ Generate image tags
      id: meta
      run: |
        echo "IMAGE_TAG=guild-isolation-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        echo "LATEST_TAG=guild-isolation-latest" >> $GITHUB_OUTPUT
        echo "ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_OUTPUT
        echo "IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:guild-isolation-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        
    - name: ğŸ³ Build Docker image
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.IMAGE_TAG }} .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.IMAGE_TAG }} $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.LATEST_TAG }}
      env:
        ECR_REGISTRY: ${{ steps.meta.outputs.ECR_REGISTRY }}
        
    - name: ğŸš€ Push Docker image to ECR
      run: |
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.IMAGE_TAG }}
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ steps.meta.outputs.LATEST_TAG }}
      env:
        ECR_REGISTRY: ${{ steps.meta.outputs.ECR_REGISTRY }}
        
    - name: ğŸ“ Download ECS task definition
      run: |
        aws ecs describe-task-definition \
          --task-definition timmybot-dev-task \
          --query taskDefinition > task-definition.json
          
    - name: ğŸ”„ Update ECS task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: task-definition.json
        container-name: ${{ env.CONTAINER_NAME }}
        image: ${{ steps.meta.outputs.IMAGE_URI }}
        
    - name: ğŸš€ Deploy to Amazon ECS
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        service: ${{ env.ECS_SERVICE }}
        cluster: ${{ env.ECS_CLUSTER }}
        wait-for-service-stability: true
        
    - name: ğŸ“Š Display deployment info
      run: |
        echo "âœ… **Deployment Successful!**"
        echo "ğŸ³ **Image**: ${{ steps.meta.outputs.IMAGE_URI }}"
        echo "ğŸ—ï¸ **ECS Service**: ${{ env.ECS_SERVICE }}"
        echo "ğŸ¯ **Cluster**: ${{ env.ECS_CLUSTER }}"
        echo "ğŸ“ **Region**: ${{ env.AWS_REGION }}"
        echo ""
        echo "ğŸ” **Verify deployment**:"
        echo "aws ecs describe-services --cluster ${{ env.ECS_CLUSTER }} --services ${{ env.ECS_SERVICE }} --region ${{ env.AWS_REGION }}"

  # ================================
  # SECURITY SCANNING (Optional)
  # ================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'